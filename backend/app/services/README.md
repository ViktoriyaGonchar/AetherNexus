# Сервисы AetherNexus Backend

## Обзор

Все бизнес-логика приложения вынесена в отдельные сервисы для лучшей организации кода и переиспользования.

## Реализованные Сервисы

### 1. IndexingService (`indexing_service.py`)

**Назначение:** Индексация проектов - парсинг кода, извлечение сущностей, создание индексов.

**Основные методы:**
- `index_project()` - Полная индексация проекта
- `_index_file()` - Индексация отдельного файла
- `_parse_python_file()` - Парсинг Python файлов через AST
- `_parse_documentation_file()` - Парсинг документации
- `delete_index()` - Удаление индекса проекта

**Особенности:**
- Поддержка Python, JavaScript, TypeScript, Java, Kotlin
- Извлечение классов, функций, методов
- Автоматическое создание связей между сущностями
- Игнорирование служебных директорий (.git, __pycache__, node_modules)

### 2. EmbeddingService (`embedding_service.py`)

**Назначение:** Генерация векторных эмбеддингов для семантического поиска.

**Основные методы:**
- `generate_embedding()` - Генерация эмбеддинга для текста
- `generate_embeddings_batch()` - Батчевая генерация

**Особенности:**
- Использует sentence-transformers (модель настраивается в config)
- Fallback на dummy эмбеддинги если модель не загружена
- Поддержка батчевой обработки для производительности

### 3. VectorService (`vector_service.py`)

**Назначение:** Работа с векторной БД Qdrant для семантического поиска.

**Основные методы:**
- `upsert()` - Добавление/обновление векторов
- `search()` - Поиск похожих векторов
- `delete_by_project()` - Удаление всех векторов проекта

**Особенности:**
- Автоматическое создание коллекции при инициализации
- Поддержка фильтров (project_id, entity_type)
- Обработка ошибок подключения
- Преобразование строковых ID в числовые для Qdrant

### 4. GraphService (`graph_service.py`)

**Назначение:** Работа с графовой БД Neo4j для хранения связей между сущностями.

**Основные методы:**
- `create_node()` - Создание узла в графе
- `create_relationship()` - Создание связи между узлами
- `get_entity_graph()` - Получение графа для сущности
- `get_entity_connections()` - Получение связей сущности
- `delete_project()` - Удаление всех узлов и связей проекта

**Особенности:**
- Поддержка различных типов связей (references, depends_on, related_to)
- Обход графа с настраиваемой глубиной
- Фильтрация по типам связей
- Обработка ошибок подключения

## Интеграция

Все сервисы интегрированы в API endpoints:

- **Search endpoints** используют `EmbeddingService` и `VectorService`
- **Index endpoints** используют `IndexingService`
- **Context endpoints** используют `GraphService` и `VectorService`
- **Graph endpoints** используют `GraphService`

## Зависимости

### Внешние сервисы:
- **Qdrant** - Векторная БД (порт 6333)
- **Neo4j** - Графовая БД (порт 7687)
- **Redis** - Кеш (опционально, порт 6379)

### Python библиотеки:
- `sentence-transformers` - Генерация эмбеддингов
- `qdrant-client` - Клиент Qdrant
- `neo4j` - Клиент Neo4j

## Конфигурация

Все настройки находятся в `app/core/config.py`:

```python
QDRANT_HOST = "localhost"
QDRANT_PORT = 6333
NEO4J_URI = "bolt://localhost:7687"
EMBEDDING_MODEL = "sentence-transformers/all-MiniLM-L6-v2"
EMBEDDING_DIMENSION = 384
```

## Обработка Ошибок

Все сервисы имеют graceful degradation:
- Если Qdrant недоступен - векторный поиск возвращает пустые результаты
- Если Neo4j недоступен - графовые операции возвращают пустые данные
- Если модель эмбеддингов не загружена - используются dummy эмбеддинги

## Производительность

- **Индексация:** Асинхронная обработка файлов
- **Поиск:** Кеширование эмбеддингов запросов (можно добавить Redis)
- **Граф:** Ограничение глубины обхода и количества узлов

## Расширение

Для добавления новых типов файлов:
1. Добавить парсер в `IndexingService._parse_*_file()`
2. Добавить расширение в `supported_extensions`
3. Обновить логику извлечения сущностей

